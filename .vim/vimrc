source ~/.vim/vim_only.vim
source ~/.vim/common.vim

" The stuff thatâ€™s in this file is stuff I havenâ€™t yet split into vim-only or
" common, so for now itâ€™s only available in vim, but thereâ€™s probably some I
" want for nvim too.

" --- Keyboard mappings ---

" Make it easy to close the window
map <leader>cx <C-w>c

" Handy for alternates.
map <leader>a :on<CR>:AV<CR><C-w><C-x> 

map <leader>ul :TestLast<CR>
map <leader>un :TestNearest<CR>
map <leader>uf :TestFile<CR>
map <leader>us :TestSuite<CR>

" Use git ls-files. Of the list of commands that fzf.vim provides, I think
" this gives what I want â€” allows me to access important hidden files e.g.
" .github/workflows (which :Files doesnâ€™t), whilst excluding .gitignore stuff
" like node_modules.
nnoremap <silent> <leader>t :GitFiles<CR>
nnoremap <silent> <leader>b :Buffers<CR>

nnoremap <Leader>ns :nohlsearch<cr>
nnoremap <Leader>nt :NERDTreeToggle<cr>
nnoremap <Leader>nf :NERDTreeFind<cr>

nnoremap <Leader>g :Ack<cr>

inoremap jk <esc>
cnoremap jk <esc>
inoremap <c-[> <nop>

" --- External options ---

let g:NERDTreeShowLineNumbers=1
let g:NERDTreeShowHidden=1
" Ignore the same 'junk' files as global.gitignore (not sure if thereâ€™s an
" easy way to DRY this, since they use different syntax)
let g:NERDTreeIgnore=['\.sw\w$', '.DS_Store']

" Testing - want console vim to warn me like MacVim does when an open file
" changes externally
" TODO: Decide whether this is overkill in terms of disk access - InsertEnter
" and InsertLeave may suffice
set autoread
autocmd CursorHold,CursorHoldI,CursorMoved,InsertEnter,InsertLeave * checktime

let g:airline#extensions#branch#enabled = 0

" We use vimterminal instead of dispatch, so that we can keep the coloured
" output, which is very useful for e.g. RSpec. The only downside I've seen is
" that if you run the tests a second time, it doesn't close the previous
" window.
let test#strategy = "vimterminal"

let g:ack_use_dispatch = 1

" invoke with '-'
nmap  -  <Plug>(choosewin)
" if you want to use overlay feature
let g:choosewin_overlay_enable = 1

" --- Filetypes for some common files ---
augroup ios
    autocmd!
    autocmd BufRead *.stringsdict :set filetype=xml

    autocmd BufRead Appfile :set filetype=ruby
    autocmd BufRead Fastfile :set filetype=ruby
    autocmd BufRead Matchfile :set filetype=ruby
    autocmd BufRead Pluginfile :set filetype=ruby
    autocmd BufRead Snapfile :set filetype=ruby
    autocmd BufRead Scanfile :set filetype=ruby

    autocmd BufRead Podfile :set filetype=ruby

    autocmd BufRead Dangerfile :set filetype=ruby
augroup END

augroup tooling
    autocmd!
    autocmd BufRead .watchmanconfig :set filetype=json
    autocmd BufRead Brewfile :set filetype=ruby
    autocmd BufRead .prettierignore :set filetype=gitignore
augroup END

" --- JSON syntax highlighting issue ---
" https://github.com/chriskempson/base16-vim/issues/125
augroup json
    autocmd!
    autocmd FileType json :highlight clear Error
augroup END

" --- Recognise .gitconfig_local
augroup git
    autocmd!
    autocmd BufRead .gitconfig_local :set filetype=gitconfig
augroup END

augroup fmt
  autocmd!
  autocmd BufWritePre *.html undojoin | Neoformat
  autocmd BufWritePre *.md undojoin | Neoformat
  autocmd BufWritePre *.scss undojoin | Neoformat
augroup END

source ~/.vim/plugins.vim

" ~/.vimrc_background is generated by the base16_<theme> command in zsh/base16-shell.sh
if filereadable(expand("~/.vimrc_background"))
    let base16colorspace=256
    source ~/.vimrc_background

    " Fix indistinguishable CoC popup menu selection highlight, copied from
    " https://github.com/neoclide/coc.nvim/wiki/F.A.Q#the-selection-highlight-does-not-look-good
    " That comment suggests it might be an issue with the colour scheme Iâ€™m
    " using ðŸ¤·
    hi CocMenuSel ctermbg=237 guibg=#13354A
    autocmd ColorScheme * hi CocMenuSel ctermbg=237 guibg=#13354A
endif

filetype plugin indent on " Required by Vundle
syntax on

" term=bold doesnâ€™t seem to do anything, cterm=bold does
highlight SelectedSearchResult term=bold cterm=bold ctermfg=DarkBlue ctermbg=LightMagenta guifg=#80a0ff gui=bold
highlight link Searchlight SelectedSearchResult

runtime coc_config.vim
